@page "/chat"

@using AzureAIAvatarBlazor.Models
@using AzureAIAvatarBlazor.Services
@using System.Text.Json
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@inject AzureAIAgentService AgentService
@inject ConfigurationService ConfigService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Chat - Azure AI Avatar</PageTitle>

<div class="container-fluid mt-3" style="position: relative; z-index: 10;">
    <div class="d-flex flex-wrap gap-2 mb-3 align-items-center glass-card p-2">
        @* Mode Indicator Badge *@
        @if (config != null)
        {
            var modeBadgeClass = config.AzureOpenAI.Mode switch
            {
                "Agent-AIFoundry" => "bg-info",
                "Agent-LLM" => "bg-success",
                "Agent-MicrosoftFoundry" => "bg-warning",
                _ => "bg-primary"
            };
            var modeDisplayText = config.AzureOpenAI.Mode switch
            {
                "Agent-AIFoundry" => "Agent: AI Foundry",
                "Agent-LLM" => "Agent: LLM",
                "Agent-MicrosoftFoundry" => "Agent: Microsoft Foundry",
                _ => "Agent"
            };
            <span class="badge @modeBadgeClass px-3 py-2">
                <i class="bi bi-cpu me-1"></i>@modeDisplayText
            </span>

            @* Avatar badge *@
            <span class="badge bg-secondary px-3 py-2 ms-2">
                <i class="bi bi-person-circle me-1"></i>@GetSelectedAvatarName()
            </span>
        }

        <div class="ms-2">
            <label class="form-label mb-0">Mode</label>
            <select class="form-select form-select-sm" @onchange="ModeChanged" value="@(config?.AzureOpenAI?.Mode)">
                <option value="Agent-LLM">@($"Agent-LLM - {(string.IsNullOrWhiteSpace(config?.AzureOpenAI?.AgentLLM?.DeploymentName) ? "gpt-5-mini" : config.AzureOpenAI.AgentLLM.DeploymentName)}")</option>
                <option value="Agent-AIFoundry">@($"Agent-AIFoundry - {(string.IsNullOrWhiteSpace(config?.AzureOpenAI?.AgentAIFoundry?.AgentId) ? "(no agent id)" : config.AzureOpenAI.AgentAIFoundry.AgentId)}")</option>
                <option value="Agent-MicrosoftFoundry">@($"Agent-MicrosoftFoundry - {(string.IsNullOrWhiteSpace(config?.AzureOpenAI?.AgentMicrosoftFoundry?.MicrosoftFoundryAgentName) ? "(no agent name)" : config.AzureOpenAI.AgentMicrosoftFoundry.MicrosoftFoundryAgentName)}")</option>
            </select>

            <div class="form-text mt-1">@GetModeInfo()</div>
        </div>

        @* Avatar selection dropdown placed here *@
        <div class="ms-3">
            <label class="form-label mb-0">Select Avatar</label>
            <select class="form-select form-select-sm" value="@SelectedAvatarId" @onchange="SelectedAvatarChanged">
                @if (avatars != null && avatars.Count > 0)
                {
                    foreach (var a in avatars)
                    {
                        <option value="@a.Id">@a.Name</option>
                    }
                }
            </select>
        </div>

        <button class="btn btn-modern btn-sm px-3" @onclick="StartAvatarSession"
            disabled="@(isSessionActive || isSessionStarting)" title="Open Avatar Session">
            <i class="bi bi-play-circle me-1"></i>Open Session
        </button>
        <button class="btn btn-modern btn-modern-success btn-sm px-3" @onclick="ToggleMicrophone" 
            disabled="@(!isSessionActive)" title="@(isMicrophoneActive ? "Stop Microphone" : "Start Microphone")">
            <i class="bi @(isMicrophoneActive ? "bi-mic-mute" : "bi-mic") me-1"></i>@(isMicrophoneActive ? "Stop Mic" : "Start Mic")
        </button>
        <button class="btn btn-outline-secondary btn-sm" @onclick="StopSpeaking" 
            disabled="@(!isSpeaking)" title="Stop Speaking">
            <i class="bi bi-stop-fill"></i>
        </button>
        <button class="btn btn-outline-danger btn-sm" @onclick="ClearChatHistory" title="Clear Chat History">
            <i class="bi bi-trash"></i>
        </button>
        <button class="btn btn-outline-primary btn-sm" @onclick="StopSession" 
            disabled="@(!isSessionActive)" title="Close Avatar Session">
            <i class="bi bi-x-circle"></i>
        </button>
    </div>

    <div class="row g-3">
        <!-- Left: Avatar Video -->
        <div class="col-12 col-lg-8">
            <div class="card glass-card shadow-sm">
                <div class="card-body p-0">
                    <div id="videoContainer" class="video-container" style="min-height: 400px; background: linear-gradient(135deg, #2D1A4D 0%, #1A0D2E 100%); position: relative;">
                        <div id="remoteVideo"></div>
                        @if (config?.Avatar?.EnableSubtitles == true)
                        {
                            <div id="subtitles" class="subtitles"></div>
                        }
                        @if (isSessionStarting)
                        {
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 26, 77, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px);">
                                <div class="spinner-border text-white" role="status" style="width: 3rem; height: 3rem; border-color: rgba(255,255,255,0.3); border-top-color: white;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="text-white mt-3" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.5);">Connecting to avatar...</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Conversation -->
        <div class="col-12 col-lg-4">
            <div class="card glass-card shadow-sm h-100">
                <div class="card-header" style="background: rgba(91, 45, 144, 0.1); border-bottom: 2px solid rgba(91, 45, 144, 0.2);">
                    <h5 class="mb-0" style="color: #2D1A4D;"><i class="bi bi-chat-dots me-2" style="color: #5B2D90;"></i>Conversation</h5>
                </div>
                <div class="card-body d-flex flex-column p-0" style="height: 400px;">
                    <!-- Chat messages area with bubbles -->
                    <div class="chat-messages-container flex-grow-1 overflow-auto p-3" id="chatContainer">
                        @foreach (var message in chatMessages.Where(m => m.Role != "system"))
                        {
                            <div class="chat-message-wrapper @(message.Role == "user" ? "user-message" : "assistant-message")">
                                <div class="chat-bubble @(message.Role == "user" ? "user-bubble" : "assistant-bubble")">
                                    <div class="chat-bubble-header">@GetMessageLabel(message.Role)</div>
                                    <div class="chat-bubble-content">@message.Content</div>
                                </div>
                            </div>
                        }
                        @if (isTyping)
                        {
                            <div class="chat-message-wrapper assistant-message">
                                <div class="chat-bubble assistant-bubble">
                                    <div class="chat-bubble-header">@(config?.Avatar?.AssistantLabel ?? "AI Avatar")</div>
                                    <div class="typing-indicator">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Input area -->
                    <div class="chat-input-container border-top p-3">
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            @if (config?.PredefinedQuestions != null)
                            {
                                var validQuestions = config.PredefinedQuestions.Where(p => !string.IsNullOrWhiteSpace(p.Question)).ToList();
                                if (validQuestions.Count > 0)
                                {
                                    foreach (var pq in validQuestions)
                                    {
                                        var qText = pq.Question ?? string.Empty;
                                        var btnLabel = string.IsNullOrWhiteSpace(pq.Title)
                                            ? (pq.Question?.Length > 30 ? pq.Question[..30] + "..." : pq.Question)
                                            : pq.Title;
                                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="() => SendPredefinedMessage(qText)" disabled="@(!isSessionActive)">
                                            @btnLabel
                                        </button>
                                    }
                                }
                            }
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Type a message..." @bind="userMessage"
                                @bind:event="oninput" @onkeydown="HandleKeyPress" disabled="@(!isSessionActive)"
                                id="messageInput" style="border-color: rgba(91, 45, 144, 0.3);">
                            <button class="btn btn-modern" @onclick="SendMessage"
                                disabled="@(!isSessionActive || string.IsNullOrWhiteSpace(userMessage))">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Toast notifications *@
<div aria-live="polite" aria-atomic="true" class="position-relative">
  <div class="toast-container position-absolute top-0 end-0 p-3">
    <div class="toast" role="alert" id="avatarToast">
      <div class="toast-header">
        <strong class="me-auto">Avatar</strong>
        <small class="text-muted">now</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        Avatar selection saved.
      </div>
    </div>
  </div>
</div>

@code {
    private AvatarConfiguration? config;
    private List<ChatMessage> chatMessages = new();
    private string userMessage = string.Empty;
    private bool isSessionActive = false;
    private bool isSessionStarting = false;
    private bool isSpeaking = false;
    private bool isTyping = false;
    private bool isMicrophoneActive = false;
    private DotNetObjectReference<Chat>? dotNetReference;

    // Avatar state
    private List<AvatarProfile> avatars = new();
    private string SelectedAvatarId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        config = await ConfigService.GetConfigurationAsync();
        ConfigService.ConfigurationChanged += OnConfigurationChanged;

        if (config?.Avatars != null && config.Avatars.Count > 0)
            avatars = config.Avatars;

        SelectedAvatarId = config?.SelectedAvatarId ?? config?.Avatar?.Character ?? string.Empty;
        if (string.IsNullOrWhiteSpace(SelectedAvatarId) && avatars.Count > 0)
            SelectedAvatarId = avatars[0].Id;

        // add system prompt if present
        if (!string.IsNullOrEmpty(config?.AzureOpenAI?.AgentLLM?.SystemPrompt))
        {
            chatMessages.Add(new ChatMessage { Role = "system", Content = config.AzureOpenAI.AgentLLM.SystemPrompt });
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Create and register the .NET reference for JS callbacks
            dotNetReference = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setDotNetAvatarRef", dotNetReference);
        }
    }

    private async Task ApplySelectedProfileToConfigAsync(string id, bool applySave = false)
    {
        if (config == null) return;
        var profile = avatars.FirstOrDefault(a => string.Equals(a.Id, id, StringComparison.OrdinalIgnoreCase));
        if (profile != null)
        {
            config.SelectedAvatarId = profile.Id;
            
            // Use the centralized ApplyTo method
            profile.ApplyTo(config.Avatar, config.SttTts);

            if (applySave)
            {
                await ConfigService.SaveConfigurationAsync(config);
                await ShowAvatarSavedToastAsync(profile.Name ?? profile.Id);
            }
        }
    }

    private async Task ShowAvatarSavedToastAsync(string avatarName)
    {
        try
        {
            // Update toast message and show it via JS
            await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('avatarToast').querySelector('.toast-body').textContent = 'Selected avatar: {avatarName}';");
            await JSRuntime.InvokeVoidAsync("eval", "var t = new bootstrap.Toast(document.getElementById('avatarToast')); t.show();");
        }
        catch
        {
            // ignore failures showing toast
        }
    }

    private string GetSelectedAvatarName()
    {
        if (avatars == null || avatars.Count == 0) return config?.Avatar?.Character ?? string.Empty;
        var match = avatars.FirstOrDefault(a => string.Equals(a.Id, SelectedAvatarId, StringComparison.OrdinalIgnoreCase));
        return match?.Name ?? SelectedAvatarId;
    }

    private async Task SelectedAvatarChanged(ChangeEventArgs e)
    {
        var newId = e.Value?.ToString() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(newId)) return;
        SelectedAvatarId = newId;
        await ApplySelectedProfileToConfigAsync(newId, applySave: true);
        StateHasChanged();
    }

    private async Task StartAvatarSession()
    {
        try
        {
            if (config == null) throw new InvalidOperationException("Configuration not loaded.");

            // Ensure selected profile applied
            await ApplySelectedProfileToConfigAsync(SelectedAvatarId, applySave: false);

            isSessionStarting = true;
            StateHasChanged();

            var validationError = await ConfigService.ValidateConfigurationAsync(config);
            if (validationError != null) throw new Exception($"Configuration error: {validationError}");

            // Validate that custom voice settings are present when required
            if (!config.Avatar.UseBuiltInVoice)
            {
                var customEndpoint = config.SttTts.CustomVoiceEndpointId;
                var ttsVoice = config.SttTts.TtsVoice;
                if (string.IsNullOrWhiteSpace(customEndpoint) || string.IsNullOrWhiteSpace(ttsVoice))
                {
                    throw new InvalidOperationException("Custom voice is selected for the avatar but CustomVoiceEndpointId or TtsVoice is not configured. Please configure them in the Configuration page.");
                }
            }

            var options = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase, WriteIndented = true };
            var configJson = JsonSerializer.Serialize(config, options);

            await JSRuntime.InvokeVoidAsync("startAvatarSessionFromJson", configJson);

            isSessionActive = true;
            isSessionStarting = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            isSessionActive = false;
            isSessionStarting = false;
            StateHasChanged();
            chatMessages.Add(new ChatMessage { Role = "system", Content = $"Error starting avatar: {ex.Message}" });
        }
    }

    private string GetMessageLabel(string role)
    {
        if (config == null) return role;
        return role.ToLower() switch
        {
            "user" => config.Avatar.UserLabel ?? "User",
            "assistant" => config.Avatar.AssistantLabel ?? "AI Avatar",
            _ => role
        };
    }

    private string GetModeInfo()
    {
        if (config == null) return string.Empty;
        var mode = config.AzureOpenAI.Mode ?? "Agent-LLM";
        return mode switch
        {
            "Agent-LLM" => $"Agent-LLM - {(string.IsNullOrWhiteSpace(config.AzureOpenAI.AgentLLM.DeploymentName) ? "gpt-5.1-chat" : config.AzureOpenAI.AgentLLM.DeploymentName)}",
            "Agent-AIFoundry" => $"Agent-AIFoundry - {(string.IsNullOrWhiteSpace(config.AzureOpenAI.AgentAIFoundry.AgentId) ? "(no agent id)" : config.AzureOpenAI.AgentAIFoundry.AgentId)}",
            "Agent-MicrosoftFoundry" => $"Agent-MicrosoftFoundry - {(string.IsNullOrWhiteSpace(config.AzureOpenAI.AgentMicrosoftFoundry.MicrosoftFoundryAgentName) ? "(no agent name)" : config.AzureOpenAI.AgentMicrosoftFoundry.MicrosoftFoundryAgentName)}",
            _ => mode
        };
    }

    private async Task ModeChanged(ChangeEventArgs e)
    {
        var newMode = e.Value?.ToString() ?? "Agent-LLM";
        if (config == null) config = await ConfigService.GetConfigurationAsync();
        config.AzureOpenAI.Mode = newMode;
        await ConfigService.SaveConfigurationAsync(config);
        try { await AgentService.ResetAgentAsync(); } catch { }
        StateHasChanged();
    }

    private async Task ScrollToBottom()
    {
        try { await JSRuntime.InvokeVoidAsync("scrollChatToBottom"); } catch { }
    }

    private async Task StopSession()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("stopAvatarSession");
            isSessionActive = false;
            isMicrophoneActive = false;
            isSessionStarting = false;
            StateHasChanged();
        }
        catch { }
    }

    private async Task ToggleMicrophone()
    {
        if (!isSessionActive) return;
        isMicrophoneActive = !isMicrophoneActive;
        await JSRuntime.InvokeVoidAsync("toggleMicrophone", isMicrophoneActive);
        if (isMicrophoneActive) await StartSpeaking(); else await StopSpeaking();
        StateHasChanged();
    }

    private async Task StartSpeaking()
    {
        if (isSpeaking || string.IsNullOrWhiteSpace(userMessage)) return;
        isSpeaking = true; StateHasChanged();
        try { var speakingTime = CalculateSpeakingTime(userMessage); await Task.Delay(speakingTime); } catch { }
        finally { isSpeaking = false; StateHasChanged(); }
    }

    private async Task StopSpeaking()
    {
        try { isSpeaking = false; await JSRuntime.InvokeVoidAsync("stopSpeaking"); StateHasChanged(); } catch { }
    }

    private int CalculateSpeakingTime(string message) => Math.Max(500, Math.Min(5000, message.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length * 100));

    private async Task ClearChatHistory()
    {
        var systemMessage = chatMessages.FirstOrDefault(m => m.Role == "system");
        chatMessages.Clear(); if (systemMessage != null) chatMessages.Add(systemMessage);
        try { await JSRuntime.InvokeVoidAsync("clearChatHistory"); } catch { }
        StateHasChanged();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e) { if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userMessage)) await SendMessage(); }

    private async Task SendMessage() { await ProcessOutgoingMessageAsync(userMessage, clearInput: true); }

    private Task SendPredefinedMessage(string presetMessage) => ProcessOutgoingMessageAsync(presetMessage, clearInput: true);

    private async Task ProcessOutgoingMessageAsync(string? content, bool clearInput)
    {
        if (string.IsNullOrWhiteSpace(content)) { if (clearInput) { userMessage = string.Empty; StateHasChanged(); } return; }
        var message = content!.Trim(); if (clearInput) { userMessage = string.Empty; StateHasChanged(); }
        chatMessages.Add(new ChatMessage { Role = "user", Content = message }); isTyping = true; StateHasChanged(); await ScrollToBottom();

        try
        {
            var messagesForAPI = chatMessages.Select(m => new ChatMessage { Role = m.Role, Content = m.Content }).ToList();
            var assistantResponse = new System.Text.StringBuilder();
            var mode = config?.AzureOpenAI.Mode ?? "Agent-LLM";
            if (mode == "Agent-LLM" || mode == "Agent-AIFoundry" || mode == "Agent-MicrosoftFoundry")
            {
                await foreach (var chunk in AgentService.GetChatCompletionStreamAsync(messagesForAPI)) assistantResponse.Append(chunk);
            }
            else throw new InvalidOperationException($"Unsupported mode: {mode}");

            var fullResponse = assistantResponse.ToString();
            chatMessages.Add(new ChatMessage { Role = "assistant", Content = fullResponse });
            StateHasChanged(); await ScrollToBottom();

            if (isSessionActive)
            {
                isSpeaking = true; StateHasChanged();
                try { await JSRuntime.InvokeVoidAsync("speakText", fullResponse); } catch { }
                finally { isSpeaking = false; }
            }
        }
        catch (NotImplementedException nie) { HandleAgentNotImplemented(nie); }
        catch (Exception) { chatMessages.Add(new ChatMessage { Role = "assistant", Content = "An error occurred while processing the request." }); StateHasChanged(); }
        finally { isTyping = false; isSpeaking = false; StateHasChanged(); }
    }

    [JSInvokable("OnSpeechRecognized")]
    public async Task OnSpeechRecognizedAsync(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return;
        userMessage = text; StateHasChanged(); await SendMessage();
    }

    [JSInvokable("OnMicrophoneStateChanged")]
    public async Task OnMicrophoneStateChangedAsync(bool active) { isMicrophoneActive = active; StateHasChanged(); }

    private void HandleAgentNotImplemented(NotImplementedException nie) { chatMessages.Add(new ChatMessage { Role = "system", Content = $"Selected agent mode is not available: {nie.Message}" }); StateHasChanged(); }

    private void OnConfigurationChanged(object? sender, AvatarConfiguration? newConfig)
    {
        InvokeAsync(async () =>
        {
            if (newConfig != null)
            {
                config = newConfig;
            }
            else
            {
                config = await ConfigService.GetConfigurationAsync();
            }
            // update avatars list when config changes
            if (config?.Avatars != null && config.Avatars.Count > 0)
            {
                avatars = config.Avatars;
            }
            StateHasChanged();
        });
    }

    public async ValueTask DisposeAsync()
    {
        try { ConfigService.ConfigurationChanged -= OnConfigurationChanged; } catch { }
        dotNetReference?.Dispose(); dotNetReference = null; await Task.CompletedTask;
    }
}